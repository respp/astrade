from typing import Optional, List
from pydantic import BaseModel, Field
from datetime import datetime


class UserCreateRequest(BaseModel):
    """Request model for creating a new user with Google/Apple login"""
    provider: str = Field(..., description="Authentication provider (google or apple)")
    email: str = Field(..., description="User email from OAuth provider")
    cavos_user_id: str = Field(..., description="Unique ID from the OAuth provider")
    wallet_address: str = Field(..., description="Wallet address generated by Cavos")


class UserCreateResponse(BaseModel):
    """Response model for user creation"""
    success: bool = True
    data: dict = Field(default_factory=dict)

    @classmethod
    def create_success(cls, user_id: str, created_at: datetime):
        """Create a successful response"""
        return cls(
            success=True,
            data={
                "user_id": user_id,
                "created_at": created_at.isoformat()
            }
        )


class UserApiCredentials(BaseModel):
    """API credentials model"""
    user_id: str
    extended_api_key: Optional[str] = None
    extended_secret_key: Optional[str] = None
    extended_stark_private_key: str
    environment: str = "testnet"
    is_mock_enabled: bool = True
    created_at: datetime
    updated_at: datetime


class User(BaseModel):
    """User model"""
    id: str
    email: Optional[str] = None
    provider: Optional[str] = None
    cavos_user_id: Optional[str] = None
    wallet_address: Optional[str] = None
    created_at: datetime
    updated_at: datetime
    api_credentials: Optional[UserApiCredentials] = None

    class Config:
        from_attributes = True


class UserResponse(BaseModel):
    """Standard user response model"""
    user_id: str
    email: Optional[str] = None
    created_at: datetime
    has_api_credentials: bool = False


class StarknetWalletOnboardingRequest(BaseModel):
    """Request model for Extended onboarding with Starknet wallet via Cavos"""
    # Wallet data from Cavos
    private_key: str = Field(..., description="Starknet private key from Cavos wallet")
    public_key: str = Field(..., description="Starknet public key from Cavos wallet") 
    address: str = Field(..., description="Starknet wallet address")
    network: str = Field(default="sepolia", description="Network: sepolia or mainnet")
    
    # Cavos authentication data
    access_token: str = Field(..., description="User's Cavos access token for transaction signing")
    org_id: str = Field(..., description="Cavos organization ID")
    user_id: str = Field(..., description="Cavos user ID")
    
    # Optional fields
    vault_id: Optional[int] = Field(None, description="Vault ID (optional)")
    environment: str = Field(default="testnet", description="Extended environment: testnet or mainnet")
    referral_code: Optional[str] = Field(None, description="Referral code (optional)")
    
    class Config:
        json_schema_extra = {
            "example": {
                "private_key": "0x1234567890abcdef...",
                "public_key": "0xabcdef1234567890...",
                "address": "0x067a5c3e7c4e5b7d9f...",
                "network": "sepolia",
                "access_token": "cavos_access_token_here",
                "org_id": "org-123",
                "user_id": "auth0|1234567890",
                "vault_id": 123456,
                "environment": "testnet",
                "referral_code": "ASTRADE2024"
            }
        }


class ExtendedOnboardingResponse(BaseModel):
    """Response model for Extended onboarding"""
    success: bool
    account_id: Optional[str] = None
    transaction_hash: Optional[str] = None
    environment: str
    message: str
    setup_completed: bool
    next_steps: List[str] = []
    
    class Config:
        json_schema_extra = {
            "example": {
                "success": True,
                "account_id": "extended_testnet_12345678_1640995200",
                "transaction_hash": "0x987654321fedcba987654321fedcba9876543210",
                "environment": "testnet",
                "message": "Extended Exchange account created successfully",
                "setup_completed": True,
                "next_steps": [
                    "Extended Exchange account is now active",
                    "Transaction confirmed on Starknet",
                    "You can now start trading with Extended Exchange",
                    "Check your balance and begin exploring features"
                ]
            }
        }


class X10OnboardingRequest(BaseModel):
    """Request model for X10 perpetual trading onboarding"""
    eth_private_key: str = Field(..., description="Ethereum private key for L1 operations")
    user_id: str = Field(..., description="AsTrade user ID")
    
    class Config:
        json_schema_extra = {
            "example": {
                "eth_private_key": "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef",
                "user_id": "user_12345"
            }
        }


class X10OnboardingResponse(BaseModel):
    """Response model for X10 perpetual trading onboarding"""
    success: bool
    account_data: Optional[dict] = None
    message: str
    setup_completed: bool
    next_steps: List[str] = []
    
    class Config:
        json_schema_extra = {
            "example": {
                "success": True,
                "account_data": {
                    "l2_vault": "123456",
                    "l2_public_key": "0xabcdef...",
                    "l2_private_key": "0x123456...",
                    "api_key": "trading_key_123",
                    "claim_id": "claim_456"
                },
                "message": "X10 perpetual trading account created successfully",
                "setup_completed": True,
                "next_steps": [
                    "X10 perpetual trading account is now active",
                    "Testnet funds claimed successfully",
                    "You can now start perpetual trading",
                    "Check your balance and positions"
                ]
            }
        }


class X10AccountGenerationRequest(BaseModel):
    """Request model for generating new X10 account from zero"""
    user_id: str = Field(..., description="AsTrade user ID")
    
    class Config:
        json_schema_extra = {
            "example": {
                "user_id": "user_12345"
            }
        }


class X10AccountGenerationResponse(BaseModel):
    """Response model for X10 account generation from zero"""
    success: bool
    generated_account: Optional[dict] = None
    message: str
    setup_completed: bool
    next_steps: List[str] = []
    
    class Config:
        json_schema_extra = {
            "example": {
                "success": True,
                "generated_account": {
                    "eth_address": "0x1234567890abcdef1234567890abcdef12345678",
                    "eth_private_key": "0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef",
                    "l2_vault": "123456",
                    "l2_public_key": "0xabcdef...",
                    "l2_private_key": "0x123456...",
                    "api_key": "trading_key_123",
                    "claim_id": "claim_456"
                },
                "message": "New X10 perpetual trading account generated successfully",
                "setup_completed": True,
                "next_steps": [
                    "New Ethereum account generated",
                    "X10 perpetual trading account created",
                    "Testnet funds claimed successfully",
                    "All credentials stored securely",
                    "You can now start perpetual trading"
                ]
            }
        }